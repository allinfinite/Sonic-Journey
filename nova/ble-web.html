<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Lumenate Nova</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
    }
    h1 { color: #00d4ff; font-size: 24px; margin-bottom: 4px; }
    .subtitle { color: #666; font-size: 13px; margin-bottom: 20px; }
    .buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      background: #00d4ff;
      color: #1a1a2e;
      border: none;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 12px;
      flex: 1;
      min-width: 140px;
    }
    button:active { background: #00a8cc; transform: scale(0.98); }
    button:disabled { background: #444; color: #666; cursor: not-allowed; }
    button, .preset, .pattern-btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    button.danger { background: #ff6b6b; }
    #log {
      background: #0d0d1a;
      padding: 16px;
      border-radius: 12px;
      font-family: ui-monospace, monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 40vh;
      overflow-y: auto;
      margin-top: 20px;
      line-height: 1.4;
    }
    .success { color: #51cf66; }
    .error { color: #ff6b6b; }
    .data { color: #ffd93d; }
    .service { color: #ff6b6b; font-weight: bold; }
    .char { color: #4ecdc4; }
    .info { color: #74c0fc; }
    #battery {
      font-size: 18px;
      margin: 15px 0;
      padding: 12px;
      background: #252547;
      border-radius: 8px;
      display: none;
    }

    /* Effects */
    .section { margin-bottom: 24px; }
    .section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #00d4ff;
      margin-bottom: 10px;
    }
    #presets { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); max-width: 800px; margin: 0 auto; }
    .preset {
      background: #252547;
      border: 2px solid #333;
      border-radius: 12px;
      padding: 20px 16px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .preset:hover:not(:disabled) { border-color: #00d4ff; background: #2a2a52; transform: translateY(-2px); }
    .preset:active:not(:disabled) { transform: translateY(0); }
    .preset:disabled { opacity: 0.4; cursor: not-allowed; }
    .preset .state-name { font-size: 20px; font-weight: 700; color: #00d4ff; margin-bottom: 6px; }
    .preset .hz { font-size: 14px; color: #888; }
    .preset.active { border-color: #00d4ff; background: #1e3a5f; box-shadow: 0 0 12px rgba(0, 212, 255, 0.3); }
    .preset.active .state-name { color: #00d4ff; }

  </style>
</head>
<body>
  <h1>Lumenate Nova</h1>
  <p class="subtitle">Click a state to start flickering</p>

  <div id="battery"></div>

  <div class="buttons">
    <button id="connectBtn" onclick="connectDevice()">Connect</button>
    <button id="disconnectBtn" onclick="disconnectDevice()" disabled class="danger">Disconnect</button>
  </div>

  <div class="section" style="margin-top: 24px;">
    <div id="presets"></div>
  </div>

  <div id="log">Tap Connect to start...</div>

  <script>
    // Known Lumenate Nova Service UUIDs
    const CONTROL_SERVICE = '47bbfb1e-670e-4f81-bfb3-78daffc9a783';
    const MCUMGR_SERVICE = 'b568de7c-b6c6-42cb-8303-fcc9cb25007c';
    const BATTERY_SERVICE = '0000180f-0000-1000-8000-00805f9b34fb';

    // Characteristics
    const DATA_CHAR = '2b35ef1f-11a6-4089-8cd5-843c5d0c9c55';
    const COMMAND_CHAR = '3e25a3bf-bfe1-4c71-97c5-5bdb73fac89e';
    const STATUS_CHAR = '964fbffe-6940-4371-8d48-fe43b07ed00b';

    let device = null;
    let server = null;
    let commandChar = null;

    // --- Simplified states: click to activate ---
    const STATES = [
      { hz: 3,  name: 'Deep Sleep',   desc: '3 Hz' },
      { hz: 6,  name: 'Meditation',   desc: '6 Hz' },
      { hz: 10, name: 'Visuals',      desc: '10 Hz' },
      { hz: 15, name: 'Focus',        desc: '15 Hz' },
    ];
    let activeState = null;

    function log(msg, className = '') {
      const logEl = document.getElementById('log');
      const line = document.createElement('div');
      line.className = className;
      line.textContent = msg;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // Build BLE flicker command. Format: 01ff + frequency
    function buildFlickerCommand(freqHz) {
      const hz = Math.max(1, Math.min(50, Math.round(freqHz)));
      // Known trigger: 01ff, then frequency byte
      return [0x01, 0xFF, hz];
    }

    async function activateState(hz) {
      if (!commandChar && !window.dataChar) { log('Not connected', 'error'); return; }
      activeState = hz;
      const state = STATES.find(s => s.hz === hz);
      
      // Try multiple approaches:
      // 1. Send 01ff trigger first, then frequency to DATA_CHAR
      // 2. Send 01ff + freq to DATA_CHAR
      // 3. Send 01ff + freq to COMMAND_CHAR
      
      const trigger = [0x01, 0xFF];
      const freqByte = [hz];
      
      // Approach 1: Send 01ff trigger, then frequency to DATA_CHAR
      if (window.dataChar) {
        try {
          await window.dataChar.writeValue(new Uint8Array(trigger));
          log(`Sent trigger 01ff to DATA_CHAR`, 'info');
          await new Promise(r => setTimeout(r, 50)); // Small delay
          await window.dataChar.writeValue(new Uint8Array(freqByte));
          log(`Sent frequency ${hz} (0x${hz.toString(16)}) to DATA_CHAR`, 'info');
          log(`Activated: ${state?.name || hz + ' Hz'}`, 'success');
          renderPresets();
          return;
        } catch (e) {
          log(`DATA_CHAR approach failed: ${e.message}`, 'error');
        }
      }
      
      // Approach 2: Send 01ff + freq together to DATA_CHAR
      if (window.dataChar) {
        try {
          const combined = [0x01, 0xFF, hz];
          await window.dataChar.writeValue(new Uint8Array(combined));
          log(`Activated: ${state?.name || hz + ' Hz'} (01ff${hz.toString(16).padStart(2, '0')} to DATA_CHAR)`, 'success');
          renderPresets();
          return;
        } catch (e) {
          log(`DATA_CHAR combined failed: ${e.message}`, 'error');
        }
      }
      
      // Approach 3: Send 01ff + freq to COMMAND_CHAR
      if (commandChar) {
        try {
          const bytes = buildFlickerCommand(hz);
          await commandChar.writeValue(new Uint8Array(bytes));
          log(`Activated: ${state?.name || hz + ' Hz'} (${bytes.map(b => b.toString(16).padStart(2, '0')).join('')} to COMMAND_CHAR)`, 'success');
        } catch (e) {
          log(`COMMAND_CHAR failed: ${e.message}`, 'error');
        }
      }
      
      renderPresets();
    }

    function renderPresets() {
      const disabled = !commandChar;
      const html = STATES.map(s => {
        const isActive = activeState === s.hz;
        return `<button class="preset${isActive ? ' active' : ''}" data-hz="${s.hz}" ${disabled ? 'disabled' : ''} type="button">
          <div class="state-name">${s.name}</div>
          <div class="hz">${s.desc}</div>
        </button>`;
      }).join('');
      document.getElementById('presets').innerHTML = html;
      document.getElementById('presets').querySelectorAll('.preset').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.disabled) return;
          const hz = parseInt(btn.dataset.hz, 10);
          activateState(hz);
        });
      });
    }

    async function connectDevice() {
      clearLog();
      log('Scanning for Lumenate Nova...');

      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'Lumenate' }],
          optionalServices: [CONTROL_SERVICE, MCUMGR_SERVICE, BATTERY_SERVICE, '180f']
        });

        log('Found: ' + device.name, 'success');
        device.addEventListener('gattserverdisconnected', onDisconnected);

        log('Connecting...');
        server = await device.gatt.connect();
        log('Connected!', 'success');

        document.getElementById('connectBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = false;

        // Get Battery Level
        try {
          const batteryService = await server.getPrimaryService('battery_service');
          const batteryChar = await batteryService.getCharacteristic('battery_level');
          const batteryValue = await batteryChar.readValue();
          const batteryLevel = batteryValue.getUint8(0);
          document.getElementById('battery').style.display = 'block';
          document.getElementById('battery').textContent = `Battery: ${batteryLevel}%`;
          log(`Battery: ${batteryLevel}%`, 'info');
        } catch (e) {
          log('Battery read skipped', 'info');
        }

        // Discover Control Service
        log('\nDiscovering services...');

        try {
          const controlService = await server.getPrimaryService(CONTROL_SERVICE);
          log('\nControl Service found!', 'service');

          const norm = (u) => (String(u || '').toLowerCase().replace(/-/g, ''));
          let fallbackWrite = null;
          let dataChar = null;

          const chars = await controlService.getCharacteristics();
          for (const char of chars) {
            const uuid = char.uuid;
            const props = [];
            if (char.properties.read) props.push('read');
            if (char.properties.write) props.push('write');
            if (char.properties.writeWithoutResponse) props.push('writeNoResp');
            if (char.properties.notify) props.push('notify');

            log(`  ${uuid.slice(0,8)}... (${props.join(', ')})`, 'char');

            // Match command char (UUID can vary in format/casing)
            if (norm(uuid) === norm(COMMAND_CHAR)) {
              commandChar = char;
              log('  ^ Command char ready', 'success');
            }
            // Also track DATA_CHAR as alternative
            if (norm(uuid) === norm(DATA_CHAR)) {
              dataChar = char;
              log('  ^ Data char found (can also write)', 'info');
            }
            // Fallback: first writable char if COMMAND_CHAR not found
            if (!fallbackWrite && (char.properties.write || char.properties.writeWithoutResponse)) {
              fallbackWrite = char;
            }

            // Subscribe to notifications
            if (char.properties.notify) {
              try {
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (e) => {
                  const bytes = new Uint8Array(e.target.value.buffer);
                  const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
                  log(`[${uuid.slice(0,8)}] ${hex}`, 'data');
                });
                log('  ^ Subscribed', 'success');
              } catch (err) {
                // Silent fail for notify
              }
            }

            // Read initial value
            if (char.properties.read) {
              try {
                const val = await char.readValue();
                const bytes = new Uint8Array(val.buffer);
                const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
                log(`  Value: ${hex}`, 'data');
              } catch (err) {
                // Silent fail for read
              }
            }
          }

          if (!commandChar && fallbackWrite) {
            commandChar = fallbackWrite;
            log('  ^ Using write char as command (COMMAND_CHAR not matched)', 'info');
          }
          // Store dataChar globally for testing
          window.dataChar = dataChar;
          window.commandChar = commandChar;
          renderPresets();
        } catch (e) {
          log('Control service error: ' + e.message, 'error');
        }

        log('\n--- Ready! Listening for data ---', 'success');

      } catch (err) {
        log('Error: ' + err.message, 'error');
        console.error(err);
      }
    }

    function disconnectDevice() {
      if (device && device.gatt.connected) {
        device.gatt.disconnect();
      }
    }

    function onDisconnected() {
      log('\nDisconnected', 'error');
      document.getElementById('connectBtn').disabled = false;
      document.getElementById('disconnectBtn').disabled = true;
      document.getElementById('battery').style.display = 'none';
      device = null;
      server = null;
      commandChar = null;
      activeState = null;
      renderPresets();
    }

    // Expose for console use
    window.sendCommand = async (hexString) => {
      if (!commandChar) {
        log('Not connected', 'error');
        return;
      }
      const bytes = hexString.match(/.{1,2}/g).map(b => parseInt(b, 16));
      await commandChar.writeValue(new Uint8Array(bytes));
      log('Sent: ' + hexString, 'success');
    };
    
    // Try DATA_CHAR instead
    window.tryDataChar = async (hz) => {
      if (!window.dataChar) {
        log('Data char not available', 'error');
        return;
      }
      const bytes = buildFlickerCommand(hz, 1);
      await window.dataChar.writeValue(new Uint8Array(bytes));
      log(`Sent to DATA_CHAR: ${bytes.map(b => b.toString(16).padStart(2, '0')).join('')}`, 'success');
    };

    renderPresets();
  </script>
</body>
</html>
